<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Place</title>
</head>
<style>
    #customers {
       
        text-align: center;
        
      font-family: Arial, Helvetica, sans-serif;
      border-collapse: collapse;
      width: 75vw;
    }
    
    #customers td, #customers th {
      border: 1px solid #ddd;
      padding: 8px;
    }
    
    #customers tr:nth-child(even){background-color: #f2f2f2;}
    
    #customers tr:hover {background-color: #ddd;}
    
    #customers th {
      padding-top: 12px;
      padding-bottom: 12px;
      text-align: left;
      background-color: #f3c44e;
      color: rgb(0, 0, 0);
    }
    button{
  background-color: white;
  color: black;
  border: 2px solid #000000;
  border-radius: 50px; /* Green */
}
    </style>
<body onload="fetchEventList()">
    <a href="http://"></a>
    <h2> Welcome to Event Page</h2>
    <!-- <textarea id="response"> response</textarea> -->
    <table id="customers" ></table>
    <!--<div onload="fetchEventList()">Trending Events</div> -->
    <script >
        const url="http://localhost:3000/event"
async function fetchEventList(){
    let iat = Math.floor(Date.now() / 1000);
    const exp= Math.floor((Date.now()+(3600*24*1000))/1000);
    const metaData={
        limit:10,
        page:1
    };
    const body={
        data:{
            iat,
            exp,
            metaData
        }
    }
    const eventList= await fetch(url,{
        headers:{
            "Content-Type": 'application/json'
        },
        method:"POST",
        body:JSON.stringify(body)

        }).then(async response=>{
            const resp= await response.json()
            console.log(resp)
            if(resp){
               // document.getElementById("response").innerHTML=JSON.stringify(resp)
                localStorage.clear()
                localStorage.setItem('data',JSON.stringify(resp))
              //  $("#response").html(resp)
     
              show(resp.data)
            }
        })
    }

async function show(data){
   console.log(data);
    let tab = 
        `<tr>
          <th>Event Id</th>
          <th>Event Name</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th> ProjectStatus</th>
          <th> Participate</th>
         
         </tr>`;
    
    // Loop to access all rows 
    let i=0;
    for (let r of data.appEventList) {

        tab += `<tr> 
    <td>${r._id} </td>
    <td>${r.projectName}</td>
    <td>${r.fromDate}</td> 
    <td>${r.toDate}</td>   
    <td>${r.projectStatus?'Open':'Closed'}</td> 

    <td><button onclick="fetchToken()" id="fetch_${i++}">Participate</button> </td>         
    

</tr>`;

document.getElementById("customers").innerHTML = tab;

    }
    // Setting innerHTML as tab variable
   
 
} 

async function fetchToken(){
    // fetchToken(r._id,r.slug)
    index=event.srcElement.id.split("_")[1]
    let data=localStorage.getItem('data')
    data=JSON.parse(data).data.appEventList
    data=data
    data=data[index]
    eventId=data._id
    slug= data.slug
    const url="http://localhost:3000/token"
    let iat = Math.floor(Date.now() / 1000);
    const exp= Math.floor((Date.now()+(3600*24*1000))/1000);
    const isEmail= false;
    //const eventId= $(this).closest('tr').find('.table_id').text()//r._id
  //  console.log(eventId ,   slug);
    console.log("==================="+eventId)
    externalUserId= await ethereum.selectedAddress; //"0x54ceff083c2c71b8e23b7a98bac91cf65883e880"
    console.log(externalUserId);
    const body={
        data:{
            iat,
            exp,
            isEmail,
            externalUserId,
            eventId
        }
    }
    console.log(body);
  
    const token= await fetch(url,{
        headers:{
            "Content-Type": 'application/json'
        },
       method:"POST",
       body:JSON.stringify(body)
    }).then(async response=>{
        const resp= await response.json()
        console.log(resp)
        if(resp){
        //     const url= `http://localhost:6006/form/${slug}?token=${resp.data.userAccessToken}`
        //    window.location.replace(url)
             console.log(resp)
           const url="http://localhost:3000/participate"
           const body= {
               slug,
               token:resp.data.userAccessToken
           }
            const data= await fetch(url,{
                headers:{
                    "Content-Type": 'application/json'

                },
                method:"POST",
                body:JSON.stringify(body)
            }).then(async response=>{
                const res= await response.json()
                console.log(res)
            })
        }
    })
}
    </script>
</body>
</html>

<!--       